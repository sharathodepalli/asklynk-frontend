<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth on asklynk.vercel.app</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4CAF50, #2196F3);
            border-radius: 8px;
            color: white;
        }
        .result { 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 6px; 
            border-left: 4px solid #007bff;
        }
        .success { 
            background: #d4edda; 
            border-left-color: #28a745;
            color: #155724;
        }
        .error { 
            background: #f8d7da; 
            border-left-color: #dc3545;
            color: #721c24;
        }
        .info { 
            background: #e2e3e5; 
            border-left-color: #6c757d;
            color: #383d41;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .production {
            background: #e8f5e8;
            border-left-color: #28a745;
            color: #155724;
        }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            border: none;
            border-radius: 6px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        .code { 
            background: #f8f9fa; 
            padding: 12px; 
            border-radius: 6px; 
            font-family: 'Courier New', monospace;
            border: 1px solid #e9ecef;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .big-button {
            font-size: 18px;
            padding: 18px 36px;
            background: #28a745;
            margin: 15px 5px;
            font-weight: bold;
        }
        .big-button:hover {
            background: #218838;
        }
        .production-button {
            background: #6f42c1;
        }
        .production-button:hover {
            background: #5a2d8a;
        }
        .url-info {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #2196F3;
        }
        .status-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .domain-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Production Auth Test - asklynk.vercel.app</h1>
            <p>Testing Chrome Extension Authentication on Production Domain</p>
        </div>
        
        <div class="url-info">
            <h3>üìç Production Environment Details</h3>
            <div class="status-section">
                <div class="status-card">
                    <p><strong>üåê Current URL:</strong> <span id="currentUrl"></span></p>
                    <p><strong>üîó Extension ID:</strong> <code>dokfobplbpfdbnlfhhaemkebcjbjkmpp</code></p>
                    <p><strong>üéØ Target Domain:</strong> <code>https://asklynk.vercel.app</code></p>
                </div>
                <div class="status-card">
                    <p><strong>üîß Environment:</strong> <span id="envType">Production</span></p>
                    <p><strong>üìÖ Test Date:</strong> August 4, 2025</p>
                    <p><strong>‚ö° Status:</strong> <span id="connectionStatus">Testing...</span></p>
                </div>
            </div>
        </div>

        <div class="domain-list">
            <h4>‚úÖ Authorized Domains for Extension</h4>
            <ul>
                <li>üîß <code>http://localhost:5173</code> (Development - Primary)</li>
                <li>üîß <code>http://localhost:3001</code> (Development - Alternative)</li>
                <li>üöÄ <code>https://asklynk.vercel.app</code> (Production - New)</li>
                <li>üöÄ <code>https://asklynk-gzn56f93d-sharath-chandra-s-projects.vercel.app</code> (Production - Legacy)</li>
            </ul>
        </div>

        <div class="production result">
            <h3>üéØ Production Authentication Test</h3>
            <p>This page tests the authentication flow specifically for the production domain <strong>asklynk.vercel.app</strong></p>
        </div>

        <button class="big-button production-button" onclick="testProductionAuthFlow()">
            üöÄ Test Production Auth Flow
        </button>

        <h2>üîç Detailed Tests</h2>
        <button onclick="checkExtensionConnection()">1. Check Extension</button>
        <button onclick="checkCurrentAuthState()">2. Check Auth State</button>
        <button onclick="sendProductionLogin()">3. Production Login Test</button>
        <button onclick="verifyAuthPersistence()">4. Verify Persistence</button>
        <button onclick="testManifestPermissions()">5. Check Permissions</button>
        <button onclick="clearAuthState()">6. Clear Auth</button>
        
        <h2>üé≠ Simulate Production Login</h2>
        <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <input type="text" id="prodUsername" placeholder="Username" value="prod_user_2025" style="padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" id="prodUserId" placeholder="User ID" value="user_prod_001" style="padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                <select id="prodRole" style="padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="admin">Admin</option>
                    <option value="user">User</option>
                    <option value="moderator">Moderator</option>
                </select>
            </div>
            <button class="big-button" onclick="simulateProductionLogin()">
                ‚úÖ Simulate Production Login
            </button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        const EXTENSION_ID = 'dokfobplbpfdbnlfhhaemkebcjbjkmpp';
        
        // Display current URL and environment check
        document.getElementById('currentUrl').textContent = window.location.href;
        
        // Check if we're on the correct domain
        if (window.location.href.includes('asklynk.vercel.app')) {
            document.getElementById('envType').textContent = 'Production ‚úÖ';
            document.getElementById('connectionStatus').textContent = 'Ready to test';
        } else {
            document.getElementById('envType').innerHTML = '<span style="color: #dc3545;">Different Domain ‚ö†Ô∏è</span>';
            document.getElementById('connectionStatus').innerHTML = '<span style="color: #856404;">May not work as expected</span>';
        }
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            
            // Also log to console for debugging
            console.log(`[${type.toUpperCase()}] ${message.replace(/<[^>]*>/g, '')}`);
        }

        function checkExtensionConnection() {
            log('üîó Checking extension connection in production...', 'info');
            
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                log('‚ùå Chrome runtime not available. Extensions require Chrome browser.', 'error');
                return;
            }
            
            chrome.runtime.sendMessage(EXTENSION_ID, { type: 'CHECK_AUTH' }, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Extension connection failed: ${chrome.runtime.lastError.message}`, 'error');
                    log('üí° Make sure extension is loaded and enabled in chrome://extensions/', 'warning');
                    log('üí° Check if extension ID is correct: dokfobplbpfdbnlfhhaemkebcjbjkmpp', 'warning');
                } else {
                    log('‚úÖ Extension connected successfully in production!', 'success');
                    log(`üìä Response: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'production');
                }
            });
        }

        function checkCurrentAuthState() {
            log('üîç Checking production authentication state...', 'info');
            
            chrome.runtime.sendMessage(EXTENSION_ID, { type: 'CHECK_AUTH' }, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Auth state check failed: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    if (response.isLoggedIn) {
                        log(`‚úÖ User logged in: ${response.user.username} (${response.user.role})`, 'success');
                        log(`üîë Token available: ${response.token ? 'Yes' : 'No'}`, 'production');
                    } else {
                        log('‚ùå No user logged in', 'warning');
                    }
                    log(`üìä Full state: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'info');
                }
            });
        }

        function sendProductionLogin() {
            log('üöÄ Testing production LOGIN_SUCCESS message...', 'info');
            
            const prodAuthData = {
                type: 'LOGIN_SUCCESS',
                token: `prod_jwt_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                userId: 'prod_user_' + Math.floor(Math.random() * 10000),
                username: 'production_test_user',
                role: 'admin'
            };
            
            log(`üì§ Sending production auth data: <div class="code">${JSON.stringify(prodAuthData, null, 2)}</div>`, 'production');
            
            chrome.runtime.sendMessage(EXTENSION_ID, prodAuthData, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Production login failed: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    log('‚úÖ Production login message successful!', 'success');
                    log(`üìä Extension response: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'production');
                    
                    setTimeout(() => {
                        log('üîÑ Verifying production auth state...', 'info');
                        checkCurrentAuthState();
                    }, 500);
                }
            });
        }

        function verifyAuthPersistence() {
            log('üíæ Testing production auth persistence...', 'info');
            
            chrome.runtime.sendMessage(EXTENSION_ID, { type: 'TEST_AUTH_STORAGE' }, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Persistence test failed: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    if (response.matches) {
                        log('‚úÖ Production auth state properly persisted!', 'success');
                        log('üí° Login will survive browser restarts', 'production');
                    } else {
                        log('‚ùå Auth persistence issue detected!', 'error');
                        log('üí° User may need to login again after browser restart', 'warning');
                    }
                    log(`üìä Persistence test: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'info');
                }
            });
        }

        function testManifestPermissions() {
            log('üîê Checking extension manifest permissions...', 'info');
            
            try {
                if (chrome.runtime && chrome.runtime.getManifest) {
                    const manifest = chrome.runtime.getManifest();
                    log(`üìã Extension name: ${manifest.name}`, 'info');
                    log(`üìã Version: ${manifest.version}`, 'info');
                    log(`üìã Manifest version: ${manifest.manifest_version}`, 'info');
                    
                    if (manifest.externally_connectable) {
                        log(`üîó External connections: <div class="code">${JSON.stringify(manifest.externally_connectable, null, 2)}</div>`, 'production');
                    } else {
                        log('‚ö†Ô∏è No externally_connectable configuration found', 'warning');
                    }
                    
                    if (manifest.permissions) {
                        log(`üîê Permissions: <div class="code">${JSON.stringify(manifest.permissions, null, 2)}</div>`, 'info');
                    }
                } else {
                    log('‚ùå Cannot access extension manifest', 'error');
                }
            } catch (error) {
                log(`‚ùå Manifest check failed: ${error.message}`, 'error');
            }
        }

        function clearAuthState() {
            log('üóëÔ∏è Clearing production auth state...', 'info');
            
            chrome.runtime.sendMessage(EXTENSION_ID, { type: 'LOGOUT' }, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Logout failed: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    log('‚úÖ Production auth state cleared!', 'success');
                    
                    setTimeout(() => {
                        log('üîÑ Verifying auth state cleared...', 'info');
                        checkCurrentAuthState();
                    }, 500);
                }
            });
        }

        function simulateProductionLogin() {
            const username = document.getElementById('prodUsername').value;
            const userId = document.getElementById('prodUserId').value;
            const role = document.getElementById('prodRole').value;
            
            if (!username || !userId) {
                log('‚ùå Please enter username and user ID', 'error');
                return;
            }
            
            log('üé≠ Simulating real production login...', 'production');
            
            const realProdAuthData = {
                type: 'LOGIN_SUCCESS',
                token: `prod_jwt_real_${Date.now()}_${Math.random().toString(36).substr(2, 12)}`,
                userId: userId,
                username: username,
                role: role,
                timestamp: new Date().toISOString(),
                domain: 'asklynk.vercel.app'
            };
            
            log(`üì§ Production login data: <div class="code">${JSON.stringify(realProdAuthData, null, 2)}</div>`, 'production');
            
            chrome.runtime.sendMessage(EXTENSION_ID, realProdAuthData, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Production login simulation failed: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    log('‚úÖ Production login simulation successful!', 'success');
                    log(`üìä Extension response: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'production');
                    
                    setTimeout(() => {
                        log('üîÑ Auto-verifying production auth persistence...', 'info');
                        verifyAuthPersistence();
                    }, 800);
                }
            });
        }

        function testProductionAuthFlow() {
            log('üöÄ Starting complete production authentication flow test...', 'production');
            log('='.repeat(50), 'info');
            
            let step = 1;
            
            // Step 1: Extension check
            setTimeout(() => {
                log(`üìç Step ${step++}: Checking extension connection...`, 'info');
                checkExtensionConnection();
            }, 100);
            
            // Step 2: Initial state
            setTimeout(() => {
                log(`üìç Step ${step++}: Checking initial auth state...`, 'info');
                checkCurrentAuthState();
            }, 1500);
            
            // Step 3: Permissions check
            setTimeout(() => {
                log(`üìç Step ${step++}: Checking manifest permissions...`, 'info');
                testManifestPermissions();
            }, 2500);
            
            // Step 4: Clear existing auth
            setTimeout(() => {
                log(`üìç Step ${step++}: Clearing any existing auth...`, 'info');
                clearAuthState();
            }, 3500);
            
            // Step 5: Production login
            setTimeout(() => {
                log(`üìç Step ${step++}: Testing production login...`, 'info');
                sendProductionLogin();
            }, 5000);
            
            // Step 6: Verify persistence
            setTimeout(() => {
                log(`üìç Step ${step++}: Verifying auth persistence...`, 'info');
                verifyAuthPersistence();
            }, 6500);
            
            // Step 7: Final verification
            setTimeout(() => {
                log(`üìç Step ${step++}: Final auth state verification...`, 'info');
                checkCurrentAuthState();
                log('üèÅ Production auth flow test completed!', 'success');
                log('üí° If all steps passed, production auth is working correctly!', 'production');
            }, 8000);
        }

        // Auto-run environment validation on page load
        window.addEventListener('load', () => {
            log('üöÄ Production auth test page loaded!', 'production');
            
            if (window.location.href.includes('asklynk.vercel.app')) {
                log('‚úÖ Perfect! Running on correct production domain: asklynk.vercel.app', 'success');
                log('üí° Extension should accept messages from this domain', 'production');
            } else {
                log('‚ö†Ô∏è Not running on asklynk.vercel.app production domain', 'warning');
                log(`üìç Current URL: ${window.location.href}`, 'info');
                log('üí° For authentic production testing, deploy this page to asklynk.vercel.app', 'warning');
            }
            
            // Auto-test connection after 1 second
            setTimeout(() => {
                log('üîÑ Auto-testing extension connection...', 'info');
                checkExtensionConnection();
            }, 1000);
        });
    </script>
</body>
</html>
