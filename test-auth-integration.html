<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extension Auth Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a8b;
        }
        .success {
            color: #006400;
            background: #f0fff0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            color: #8b0000;
            background: #fff0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            color: #000080;
            background: #f0f0ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        input {
            width: 300px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß AskLynk Extension Auth Test Page</h1>
        
        <div class="info">
            <strong>Instructions:</strong><br>
            1. Install the AskLynk Chrome extension<br>
            2. Enter the Extension ID below (found at chrome://extensions/)<br>
            3. Test the authentication flow
        </div>

        <div class="test-section">
            <h3>üîë Extension Configuration</h3>
            <div>
                <label>Extension ID:</label><br>
                <input type="text" id="extensionId" placeholder="Enter extension ID here" />
                <button onclick="saveExtensionId()">Save ID</button>
            </div>
            <div id="extensionStatus"></div>
        </div>

        <div class="test-section">
            <h3>üìù Mock User Data</h3>
            <div>
                <label>User ID:</label><br>
                <input type="text" id="userId" value="test_user_123" />
            </div>
            <div>
                <label>Username:</label><br>
                <input type="text" id="username" value="john.doe" />
            </div>
            <div>
                <label>Role:</label><br>
                <input type="text" id="role" value="student" />
            </div>
            <div>
                <label>Token:</label><br>
                <input type="text" id="token" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.test.token" />
            </div>
        </div>

        <div class="test-section">
            <h3>üß™ Test Authentication</h3>
            <button onclick="testAuthMessage()">Send LOGIN_SUCCESS Message</button>
            <button onclick="clearResults()">Clear Results</button>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>üìä URL Parameters</h3>
            <div id="urlParams"></div>
            <button onclick="checkUrlParams()">Check URL Parameters</button>
        </div>

        <div class="test-section">
            <h3>üîç Debug Information</h3>
            <button onclick="showDebugInfo()">Show Debug Info</button>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        // Check if this page was opened from extension
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const isExtensionAuth = urlParams.get('extension_auth') === 'true';
            const fromExtension = urlParams.get('from_extension') === 'true';
            
            const html = `
                <div class="${isExtensionAuth ? 'success' : 'info'}">
                    <strong>URL Parameters:</strong><br>
                    extension_auth: ${urlParams.get('extension_auth') || 'not set'}<br>
                    from_extension: ${urlParams.get('from_extension') || 'not set'}<br>
                    redirect: ${urlParams.get('redirect') || 'not set'}<br><br>
                    <strong>Extension Auth Detected:</strong> ${isExtensionAuth ? '‚úÖ Yes' : '‚ùå No'}
                </div>
            `;
            document.getElementById('urlParams').innerHTML = html;
        }

        function saveExtensionId() {
            const extensionId = document.getElementById('extensionId').value.trim();
            if (extensionId) {
                localStorage.setItem('extensionId', extensionId);
                document.getElementById('extensionStatus').innerHTML = 
                    `<div class="success">Extension ID saved: ${extensionId}</div>`;
            } else {
                document.getElementById('extensionStatus').innerHTML = 
                    `<div class="error">Please enter a valid Extension ID</div>`;
            }
        }

        function testAuthMessage() {
            const extensionId = localStorage.getItem('extensionId') || document.getElementById('extensionId').value.trim();
            
            if (!extensionId) {
                document.getElementById('testResults').innerHTML = 
                    `<div class="error">‚ùå Please enter and save the Extension ID first</div>`;
                return;
            }

            const authData = {
                type: 'LOGIN_SUCCESS',
                userId: document.getElementById('userId').value,
                username: document.getElementById('username').value,
                role: document.getElementById('role').value,
                token: document.getElementById('token').value
            };

            document.getElementById('testResults').innerHTML = 
                `<div class="info">üì§ Sending message to extension ${extensionId}...</div>`;

            try {
                chrome.runtime.sendMessage(extensionId, authData, (response) => {
                    if (chrome.runtime.lastError) {
                        document.getElementById('testResults').innerHTML += 
                            `<div class="error">‚ùå Error: ${chrome.runtime.lastError.message}</div>`;
                    } else if (response && response.success) {
                        document.getElementById('testResults').innerHTML += 
                            `<div class="success">‚úÖ Extension responded successfully!</div>`;
                        
                        // Auto-close after success (simulate real auth flow)
                        setTimeout(() => {
                            document.getElementById('testResults').innerHTML += 
                                `<div class="info">üîÑ Simulating window close (in real app, window would close here)</div>`;
                        }, 1000);
                    } else {
                        document.getElementById('testResults').innerHTML += 
                            `<div class="error">‚ùå Extension returned error: ${JSON.stringify(response)}</div>`;
                    }
                });
            } catch (error) {
                document.getElementById('testResults').innerHTML += 
                    `<div class="error">‚ùå JavaScript error: ${error.message}</div>`;
            }
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('debugInfo').innerHTML = '';
        }

        function showDebugInfo() {
            const extensionId = localStorage.getItem('extensionId') || 'not set';
            const urlParams = new URLSearchParams(window.location.search);
            
            const debugHtml = `
                <div class="info">
                    <strong>Current Configuration:</strong><br>
                    Extension ID: ${extensionId}<br>
                    Page URL: ${window.location.href}<br>
                    Extension Auth: ${urlParams.get('extension_auth')}<br>
                    From Extension: ${urlParams.get('from_extension')}<br><br>
                    
                    <strong>Chrome Runtime Available:</strong> ${typeof chrome !== 'undefined' && chrome.runtime ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Can Send Messages:</strong> ${typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage ? '‚úÖ Yes' : '‚ùå No'}<br><br>
                    
                    <strong>Expected Extension Manifest:</strong><br>
                    The extension should have this domain in externally_connectable:<br>
                    <code>https://asklynk-gzn56f93d-sharath-chandra-s-projects.vercel.app/*</code>
                </div>
            `;
            document.getElementById('debugInfo').innerHTML = debugHtml;
        }

        // Auto-load saved extension ID
        window.onload = function() {
            const savedId = localStorage.getItem('extensionId');
            if (savedId) {
                document.getElementById('extensionId').value = savedId;
                document.getElementById('extensionStatus').innerHTML = 
                    `<div class="success">Loaded saved Extension ID: ${savedId}</div>`;
            }
            
            // Auto-check URL params
            checkUrlParams();
        };
    </script>
</body>
</html>
