<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth on localhost:3001</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #007bff;
        }
        .success { 
            background: #d4edda; 
            border-left-color: #28a745;
            color: #155724;
        }
        .error { 
            background: #f8d7da; 
            border-left-color: #dc3545;
            color: #721c24;
        }
        .info { 
            background: #e2e3e5; 
            border-left-color: #6c757d;
            color: #383d41;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        button { 
            padding: 12px 24px; 
            margin: 5px; 
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .code { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            font-family: 'Courier New', monospace;
            border: 1px solid #e9ecef;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .big-button {
            font-size: 16px;
            padding: 15px 30px;
            background: #28a745;
            margin: 10px 0;
        }
        .big-button:hover {
            background: #218838;
        }
        .url-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #b3d9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test Authentication on localhost:3001</h1>
        
        <div class="url-info">
            <h3>üìç Current Environment</h3>
            <p><strong>Page URL:</strong> <span id="currentUrl"></span></p>
            <p><strong>Extension ID:</strong> dokfobplbpfdbnlfhhaemkebcjbjkmpp</p>
            <p><strong>Expected Domain:</strong> http://localhost:3001</p>
        </div>

        <div class="info">
            <h3>üéØ Quick Test</h3>
            <p>This page is specifically designed to test authentication with your extension from localhost:3001</p>
        </div>

        <button class="big-button" onclick="testCompleteAuthFlow()">
            üîê Test Complete Auth Flow
        </button>

        <h2>üîç Step-by-Step Tests</h2>
        <button onclick="checkExtensionConnection()">1. Check Extension Connection</button>
        <button onclick="checkCurrentAuthState()">2. Check Current Auth State</button>
        <button onclick="sendLoginSuccessMessage()">3. Send LOGIN_SUCCESS Message</button>
        <button onclick="verifyAuthPersistence()">4. Verify Auth Persistence</button>
        <button onclick="clearAuthState()">5. Clear Auth State</button>
        
        <h2>üöÄ Simulate Real Login</h2>
        <div style="margin: 15px 0;">
            <input type="text" id="username" placeholder="Enter username" value="test_user_3001" style="padding: 10px; margin: 5px; width: 200px;">
            <input type="text" id="userId" placeholder="Enter user ID" value="user_123_3001" style="padding: 10px; margin: 5px; width: 200px;">
            <input type="text" id="role" placeholder="Enter role" value="admin" style="padding: 10px; margin: 5px; width: 100px;">
        </div>
        <button class="big-button" onclick="simulateRealLogin()">
            ‚úÖ Simulate Real Login with Form Data
        </button>
        
        <div id="results"></div>
    </div>

    <script>
        const EXTENSION_ID = 'dokfobplbpfdbnlfhhaemkebcjbjkmpp';
        
        // Display current URL
        document.getElementById('currentUrl').textContent = window.location.href;
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function checkExtensionConnection() {
            log('üîó Checking extension connection...', 'info');
            
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                log('‚ùå Chrome runtime not available. Make sure you\'re in Chrome with extensions enabled.', 'error');
                return;
            }
            
            chrome.runtime.sendMessage(EXTENSION_ID, { type: 'CHECK_AUTH' }, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Extension connection failed: ${chrome.runtime.lastError.message}`, 'error');
                    log('üí° Make sure the extension is loaded and enabled in chrome://extensions/', 'warning');
                } else {
                    log('‚úÖ Extension connected successfully!', 'success');
                    log(`üìä Current response: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'info');
                }
            });
        }

        function checkCurrentAuthState() {
            log('üîç Checking current authentication state...', 'info');
            
            chrome.runtime.sendMessage(EXTENSION_ID, { type: 'CHECK_AUTH' }, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Failed to check auth state: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    if (response.isLoggedIn) {
                        log(`‚úÖ User is logged in as: ${response.user.username} (ID: ${response.user.id})`, 'success');
                        log(`üìä User role: ${response.user.role}`, 'info');
                        log(`üîë Has token: ${response.token ? 'Yes' : 'No'}`, 'info');
                    } else {
                        log('‚ùå User is not logged in', 'warning');
                    }
                    log(`üìä Full auth state: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'info');
                }
            });
        }

        function sendLoginSuccessMessage() {
            log('üì® Sending LOGIN_SUCCESS message to extension...', 'info');
            
            const testAuthData = {
                type: 'LOGIN_SUCCESS',
                token: 'jwt_token_from_localhost_3001_' + Date.now(),
                userId: 'user_3001_' + Math.floor(Math.random() * 1000),
                username: 'test_user_3001',
                role: 'admin'
            };
            
            log(`üì§ Sending data: <div class="code">${JSON.stringify(testAuthData, null, 2)}</div>`, 'info');
            
            chrome.runtime.sendMessage(EXTENSION_ID, testAuthData, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå LOGIN_SUCCESS message failed: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    log('‚úÖ LOGIN_SUCCESS message sent successfully!', 'success');
                    log(`üìä Extension response: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'info');
                    
                    // Auto-check auth state after successful login
                    setTimeout(() => {
                        log('üîÑ Auto-checking auth state after login...', 'info');
                        checkCurrentAuthState();
                    }, 500);
                }
            });
        }

        function verifyAuthPersistence() {
            log('üíæ Testing auth state persistence...', 'info');
            
            chrome.runtime.sendMessage(EXTENSION_ID, { type: 'TEST_AUTH_STORAGE' }, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Storage test failed: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    if (response.matches) {
                        log('‚úÖ Auth state is properly stored and persistent!', 'success');
                    } else {
                        log('‚ùå Auth state storage mismatch detected!', 'error');
                        log('üí° This indicates the auth is not being saved properly', 'warning');
                    }
                    log(`üìä Storage test results: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'info');
                }
            });
        }

        function clearAuthState() {
            log('üóëÔ∏è Clearing authentication state...', 'info');
            
            chrome.runtime.sendMessage(EXTENSION_ID, { type: 'LOGOUT' }, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Logout failed: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    log('‚úÖ Authentication state cleared successfully!', 'success');
                    
                    // Auto-check auth state after logout
                    setTimeout(() => {
                        log('üîÑ Verifying auth state is cleared...', 'info');
                        checkCurrentAuthState();
                    }, 500);
                }
            });
        }

        function simulateRealLogin() {
            const username = document.getElementById('username').value;
            const userId = document.getElementById('userId').value;
            const role = document.getElementById('role').value;
            
            if (!username || !userId) {
                log('‚ùå Please enter username and user ID', 'error');
                return;
            }
            
            log('üé≠ Simulating real login with form data...', 'info');
            
            const realAuthData = {
                type: 'LOGIN_SUCCESS',
                token: `jwt_real_token_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                userId: userId,
                username: username,
                role: role || 'user'
            };
            
            log(`üì§ Sending real auth data: <div class="code">${JSON.stringify(realAuthData, null, 2)}</div>`, 'info');
            
            chrome.runtime.sendMessage(EXTENSION_ID, realAuthData, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Real login simulation failed: ${chrome.runtime.lastError.message}`, 'error');
                } else {
                    log('‚úÖ Real login simulation successful!', 'success');
                    log(`üìä Extension response: <div class="code">${JSON.stringify(response, null, 2)}</div>`, 'info');
                    
                    // Auto-verify persistence
                    setTimeout(() => {
                        log('üîÑ Verifying login persistence...', 'info');
                        verifyAuthPersistence();
                    }, 800);
                }
            });
        }

        function testCompleteAuthFlow() {
            log('üöÄ Starting complete authentication flow test...', 'info');
            log('=' * 50, 'info');
            
            // Step 1: Check extension
            setTimeout(() => checkExtensionConnection(), 100);
            
            // Step 2: Check initial auth state
            setTimeout(() => {
                log('üìç Step 2: Checking initial auth state...', 'info');
                checkCurrentAuthState();
            }, 1000);
            
            // Step 3: Clear any existing auth
            setTimeout(() => {
                log('üìç Step 3: Clearing any existing auth state...', 'info');
                clearAuthState();
            }, 2000);
            
            // Step 4: Send login message
            setTimeout(() => {
                log('üìç Step 4: Sending LOGIN_SUCCESS message...', 'info');
                sendLoginSuccessMessage();
            }, 3500);
            
            // Step 5: Verify persistence
            setTimeout(() => {
                log('üìç Step 5: Verifying auth persistence...', 'info');
                verifyAuthPersistence();
            }, 4500);
            
            // Step 6: Final state check
            setTimeout(() => {
                log('üìç Step 6: Final auth state verification...', 'info');
                checkCurrentAuthState();
                log('üèÅ Complete auth flow test finished!', 'success');
            }, 5500);
        }

        // Auto-run environment check on page load
        window.addEventListener('load', () => {
            log('üöÄ localhost:3001 auth test page loaded!', 'success');
            
            if (window.location.href.includes('localhost:3001')) {
                log('‚úÖ Correct environment: Running on localhost:3001', 'success');
                log('üí° Extension should accept messages from this domain', 'info');
            } else {
                log('‚ö†Ô∏è WARNING: Not running on localhost:3001', 'warning');
                log(`üìç Current URL: ${window.location.href}`, 'info');
                log('üí° For best results, serve this page from localhost:3001', 'warning');
            }
        });
    </script>
</body>
</html>
